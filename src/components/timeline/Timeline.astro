---
import Container from "../layout/Container.astro";
import TimelineYear from "./TimelineYear.astro";
import timeline from "../../content/timeline.json";

const years = timeline.map((b) => b.year);
---
<section class="py-16 md:py-24">
  <Container>
    <header class="mb-14 md:mb-20">
      <p class="text-sm tracking-wide text-zinc-600">studiolanza</p>
      <h1 class="mt-3 text-3xl md:text-5xl font-medium tracking-tight">
        immagine e comunicazione
      </h1>
      <p class="mt-6 max-w-2xl text-base md:text-lg leading-relaxed text-zinc-700">
        Selezione di lavori attraverso oltre vent’anni di pratica, raccontati per continuità.
      </p>
    </header>

    <div class="grid grid-cols-1 gap-10 md:grid-cols-[180px_1fr] md:gap-14">
      <!-- nav -->
      <aside class="md:sticky md:top-10 md:self-start">
        <!-- mobile -->
        <div class="md:hidden">
          <label class="sr-only" for="year-jump">Vai all’anno</label>
          <select
            id="year-jump"
            class="w-full rounded-xl border border-zinc-200 bg-white/70 px-4 py-3 text-sm"
          >
            {years.map((y) => <option value={`y-${y}`}>{y}</option>)}
          </select>
        </div>

        <!-- desktop -->
        <nav class="hidden md:block">
          <p class="mb-4 text-xs tracking-wide text-zinc-600">timeline</p>
          <ol class="space-y-2">
            {years.map((y) => (
              <li>
                <a
                  href={`#y-${y}`}
                  data-year-link={y}
                  class="inline-flex rounded-full px-3 py-1 text-sm text-zinc-700 hover:text-zinc-900 hover:bg-zinc-100"
                >
                  {y}
                </a>
              </li>
            ))}
          </ol>
        </nav>
      </aside>

      <!-- timeline -->
      <div class="relative">
        <div class="pointer-events-none absolute left-3 top-0 h-full w-px bg-zinc-200 md:left-4"></div>

        <ol class="space-y-14 md:space-y-20">
          {timeline.map((block) => (
            <li>
              <TimelineYear year={block.year} projects={block.projects} />
            </li>
          ))}
        </ol>
      </div>
    </div>
  </Container>
  <div
    id="project-overlay"
    class="fixed inset-0 z-50 hidden pointer-events-none"
    aria-hidden="true"
  >
    <div class="absolute inset-0 bg-zinc-900/30" data-overlay-backdrop></div>

    <div class="absolute inset-0 flex items-end md:items-center justify-center p-4 md:p-10">
      <div
        class="w-full max-w-2xl rounded-2xl bg-zinc-50 border border-zinc-200 shadow-sm p-6 md:p-10"
        role="dialog"
        aria-modal="true"
        aria-labelledby="overlay-title"
      >
        <div class="flex items-start justify-between gap-6">
          <div>
            <p id="overlay-meta" class="text-sm text-zinc-600"></p>
            <h2 id="overlay-title" class="mt-2 text-2xl md:text-3xl font-medium tracking-tight"></h2>
          </div>

          <button
            type="button"
            class="rounded-full border border-zinc-200 px-3 py-1 text-sm text-zinc-700 hover:bg-zinc-100"
            data-overlay-close
          >
            Chiudi
          </button>
        </div>

        <p id="overlay-excerpt" class="mt-6 text-base leading-relaxed text-zinc-700"></p>
        <div id="overlay-gallery" class="mt-8 grid grid-cols-2 gap-3"></div>
      </div>
    </div>
  </div>
</section>

<script
  id="projects-data"
  type="application/json"
  set:html={JSON.stringify(timeline)}
></script>

<script>
  // reveal
  const items = document.querySelectorAll("[data-reveal]");
  const io = new IntersectionObserver(
    (entries) => {
      for (const e of entries) {
        if (e.isIntersecting) {
          e.target.classList.add("is-visible");
          io.unobserve(e.target);
        }
      }
    },
    { threshold: 0.15 }
  );
  items.forEach((el) => io.observe(el));

  // mobile jump
  const sel = document.getElementById("year-jump");
  if (sel) {
    sel.addEventListener("change", () => {
      const id = sel.value;
      const el = document.getElementById(id);
      if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
    });
  }

  // active year (desktop) — stable
  const yearSections = document.querySelectorAll("[data-year]");
  const yearLinks = document.querySelectorAll("[data-year-link]");
  const ratios = new Map();

  const setActive = (year) => {
    yearLinks.forEach((a) => {
      const isActive = String(a.dataset.yearLink) === String(year);
      a.classList.toggle("bg-zinc-900", isActive);
      a.classList.toggle("text-zinc-50", isActive);
      a.classList.toggle("hover:bg-zinc-900", isActive);
      a.classList.toggle("hover:text-zinc-50", isActive);
    });
  };

  const pickMostVisible = () => {
    let bestYear = null;
    let bestRatio = 0;
    for (const [year, ratio] of ratios.entries()) {
      if (ratio > bestRatio) {
        bestRatio = ratio;
        bestYear = year;
      }
    }
    if (bestYear) setActive(bestYear);
  };

  const yo = new IntersectionObserver(
    (entries) => {
      for (const e of entries) {
        const year = e.target.dataset.year;
        if (e.isIntersecting) ratios.set(year, e.intersectionRatio);
        else ratios.delete(year);
      }
      pickMostVisible();
    },
    { rootMargin: "-35% 0px -55% 0px", threshold: [0, 0.2, 0.4, 0.6, 0.8] }
  );

  yearSections.forEach((s) => yo.observe(s));

  // --- data from JSON (slug -> project)
  const dataEl = document.getElementById("projects-data");
  const timelineData = dataEl ? JSON.parse(dataEl.textContent) : [];
  const projectBySlug = new Map();

  timelineData.forEach((block) => {
    (block.projects || []).forEach((p) => {
      projectBySlug.set(p.slug, { ...p, year: block.year });
    });
  });

  // overlay
  const overlay = document.getElementById("project-overlay");
  const titleEl = document.getElementById("overlay-title");
  const metaEl = document.getElementById("overlay-meta");
  const excerptEl = document.getElementById("overlay-excerpt");
  const galleryEl = document.getElementById("overlay-gallery");
  let lightbox = null;

  const openOverlay = (btn) => {
    if (!overlay) return;

    const slug = btn.dataset.project;
    const p = projectBySlug.get(slug);
    if (!p) return;

    if (titleEl) titleEl.textContent = p.title || "";
    if (metaEl) metaEl.textContent = [p.client, p.type, p.year].filter(Boolean).join(" — ");
    if (excerptEl) excerptEl.textContent = p.excerpt || "";

    // demo gallery (local)
    if (galleryEl) {
      galleryEl.innerHTML = `
        <a href="/images/projects/_demo/01.svg" class="block overflow-hidden rounded-xl border border-zinc-200" data-gallery="project">
          <img src="/images/projects/_demo/01.svg" alt="" loading="lazy" class="block w-full" />
        </a>
        <a href="/images/projects/_demo/02.svg" class="block overflow-hidden rounded-xl border border-zinc-200" data-gallery="project">
          <img src="/images/projects/_demo/02.svg" alt="" loading="lazy" class="block w-full" />
        </a>
      `;
    }

    overlay.hidden = false;
    overlay.style.pointerEvents = "auto";
    overlay.classList.remove("hidden", "pointer-events-none");
    overlay.setAttribute("aria-hidden", "false");
    document.documentElement.classList.add("overflow-hidden");

    import("glightbox").then(({ default: GLightbox }) => {
      if (lightbox) lightbox.destroy();
      lightbox = GLightbox({ selector: '[data-gallery="project"]', loop: false });
    });
  };

  const closeOverlay = () => {
    if (!overlay) return;

    overlay.classList.add("hidden", "pointer-events-none");
    overlay.style.pointerEvents = "none";
    overlay.hidden = true;
    overlay.setAttribute("aria-hidden", "true");
    document.documentElement.classList.remove("overflow-hidden");

    if (galleryEl) galleryEl.innerHTML = "";
    if (lightbox) {
      lightbox.destroy();
      lightbox = null;
    }
  };

  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-project]");

    // apri solo se overlay è chiuso
    if (btn && overlay && overlay.classList.contains("hidden")) {
      openOverlay(btn);
      return;
    }

    if (e.target.closest("[data-overlay-close]")) closeOverlay();

    const panel = e.target.closest('[role="dialog"]');
    const isOverlayClick = overlay && overlay.contains(e.target);

    if (overlay && !overlay.classList.contains("hidden") && isOverlayClick && !panel) {
      closeOverlay();
    }
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeOverlay();
  });
</script>

<style>
  [data-reveal] {
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 220ms ease, transform 220ms ease;
  }
  [data-reveal].is-visible {
    opacity: 1;
    transform: translateY(0);
  }
</style>
