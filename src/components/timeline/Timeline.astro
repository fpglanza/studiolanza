---
import Container from "../layout/Container.astro";
import TimelineYear from "./TimelineYear.astro";
import timeline from "../../content/timeline.json";
import timelineScriptUrl from "../../scripts/timeline.js?url";
import { getCollection } from "astro:content";

const years = timeline.map((b) => b.year);

const entries = await getCollection("projects");
const mdBySlug = new Map(entries.map((e) => [e.slug, e.data]));

function resolveProjects(block) {
  return (block.projects || [])
    .map((p) => {
      const data = mdBySlug.get(p.slug);
      if (!data) return null;

      return {
        slug: p.slug,
        year: block.year,
        title: data.title,
        client: data.client ?? "",
        type: data.type ?? "",
        excerpt: data.excerpt ?? "",
        tags: p.tags ?? [],
      };
    })
    .filter(Boolean);
}
---

<section class="py-16 md:py-24" data-timeline-root>
  <Container>
    <header class="mb-14 md:mb-20">
      <p class="text-sm tracking-wide text-zinc-600">studiolanza</p>
      <h1 class="mt-3 text-3xl md:text-5xl font-medium tracking-tight">
        immagine e comunicazione
      </h1>
      <p class="mt-6 max-w-2xl text-base md:text-lg leading-relaxed text-zinc-700">
        Selezione di lavori attraverso oltre vent’anni di pratica, raccontati per continuità.
      </p>
    </header>

    <!-- years nav (top) -->
    <nav aria-label="Timeline" class="mb-10 md:mb-14">
      <!-- mobile -->
      <div class="md:hidden">
        <label class="sr-only" for="year-jump">Vai all’anno</label>
        <select
          id="year-jump"
          class="w-full rounded-xl border border-zinc-200 bg-white/70 px-4 py-3 text-sm"
        >
          {years.map((y) => <option value={String(y)}>{y}</option>)}
        </select>
      </div>

      <!-- desktop -->
      <ol class="hidden md:flex md:flex-wrap md:justify-center md:gap-2">
        {years.map((y) => (
          <li>
            <button
              type="button"
              data-year-jump={y}
              data-year-link={y}
              class="inline-flex rounded-full px-3 py-1 text-sm text-zinc-700 hover:text-zinc-900 hover:bg-zinc-100"
            >
              {y}
            </button>
          </li>
        ))}
      </ol>
    </nav>

    <!-- centered timeline -->
    <div class="mx-auto w-full max-w-4xl">
    <!-- DESKTOP only -->
    <div class="hidden md:block">
      <div id="timeline-track" class="flex overflow-x-auto scroll-smooth snap-x snap-mandatory">
        {timeline.map((block) => (
          <section class="w-full shrink-0 snap-start py-12 md:py-16" data-year-panel={block.year}>
            <div class="mx-auto max-w-3xl">
              <TimelineYear year={block.year} projects={resolveProjects(block)} />
            </div>
          </section>
        ))}
      </div>
    </div>

    <!-- MOBILE only -->
    <div class="md:hidden relative">
      <div class="pointer-events-none absolute left-3 top-0 h-full w-px bg-zinc-200"></div>

        <ol class="space-y-20">
          {timeline.map((block) => (
            <li id={`y-${block.year}`} data-year={block.year}>
              <TimelineYear year={block.year} projects={resolveProjects(block)} />
            </li>
          ))}
        </ol>
    </div>
  </div>
  
  </Container>
  <div
    id="project-overlay"
    class="fixed inset-0 z-50 hidden pointer-events-none"
    aria-hidden="true"
    hidden
  >
    <div class="absolute inset-0 bg-zinc-900/30" data-overlay-backdrop></div>

    <div class="absolute inset-0 flex items-end md:items-center justify-center p-4 md:p-10">
      <div
        class="w-full max-w-2xl rounded-2xl bg-zinc-50 border border-zinc-200 shadow-sm p-6 md:p-10 overflow-auto"
        role="dialog"
        aria-modal="true"
        aria-labelledby="overlay-title"
      >
        <div class="flex items-start justify-between gap-6">
          <div>
            <p id="overlay-meta" class="text-sm text-zinc-600"></p>
            <h2 id="overlay-title" class="mt-2 text-2xl md:text-3xl font-medium tracking-tight"></h2>
          </div>

          <button
            type="button"
            class="rounded-full border border-zinc-200 px-3 py-1 text-sm text-zinc-700 hover:bg-zinc-100"
            data-overlay-close
          >
            Chiudi
          </button>
        </div>

        <p id="overlay-excerpt" class="mt-6 text-base leading-relaxed text-zinc-700"></p>
        <div id="overlay-gallery" class="mt-8 grid grid-cols-2 gap-3"></div>
        <a
          id="overlay-link"
          class="mt-4 inline-flex rounded-full border border-zinc-200 bg-white/60 px-4 py-2 text-sm text-zinc-800 hover:border-zinc-300"
          href="#"
        >
          Apri progetto
        </a>

      </div>
    </div>
  </div>
</section>

<script
  id="projects-data"
  type="application/json"
  set:html={JSON.stringify(timeline)}
></script>

<script type="module" src={timelineScriptUrl}></script>

<style>
  [data-reveal] {
    opacity: 0;
    transform: translateY(12px);
    transition: opacity 220ms ease, transform 220ms ease;
  }
  [data-reveal].is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  #timeline-track::-webkit-scrollbar {
    display: none;
  }
</style>
