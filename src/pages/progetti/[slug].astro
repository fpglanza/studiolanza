---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Container from "../../components/layout/Container.astro";
import mediaScriptUrl from "../../scripts/project-media.js?url";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((entry) => ({
    params: { slug: entry.slug },
  }));
}

const { slug } = Astro.params;

const projects = await getCollection("projects");
const entry = projects.find((p) => p.slug === slug);

if (!entry) return new Response(null, { status: 404 });

const { data } = entry;
const { Content } = await entry.render();
---

<BaseLayout title={`studiolanza — ${data.title}`}>
  <main class="py-20 md:py-28">
    <Container>
      <article class="mx-auto max-w-3xl">

        <p class="text-sm text-zinc-600">
          {data.client} · {data.type} · {data.year}
        </p>

        <h1 class="mt-3 text-3xl md:text-5xl font-medium tracking-tight">
          {data.title}
        </h1>

        {data.excerpt && (
          <p class="mt-8 text-base md:text-lg leading-relaxed text-zinc-700">
            {data.excerpt}
          </p>
        )}

        <section class="mt-14">
          <!-- thumbnails -->
          <div
            class="flex gap-3 overflow-x-auto pb-3"
            style="scrollbar-width: none;"
            aria-label="Media"
          >
            {data.media.map((m, i) => (
              <button
                type="button"
                class="media-thumb shrink-0 rounded-lg border border-zinc-200 bg-white/60 p-1"
                data-kind={m.kind}
                data-src={m.src}
                aria-current={i === 0 ? "true" : "false"}
                title={m.kind === "video" ? "Video" : `Immagine ${i + 1}`}
              >
                {m.kind === "video" ? (
                  <div class="h-16 w-24 rounded-md bg-zinc-100 grid place-items-center text-xs text-zinc-600">
                    video
                  </div>
                ) : (
                  <img
                    src={m.thumb ?? m.src}
                    alt=""
                    class="h-16 w-24 object-cover rounded-md"
                    loading="lazy"
                  />
                )}
              </button>
            ))}
          </div>

          <!-- viewer -->
          <div class="mt-6 rounded-xl border border-zinc-200 bg-white/50 overflow-hidden">
            <div id="media-viewer" class="aspect-[4/3] md:aspect-[16/10] bg-zinc-100"></div>
          </div>

          {data.media.length === 0 && (
            <p class="mt-4 text-sm text-zinc-600">Nessun media disponibile.</p>
          )}
        </section>

        <script type="module" src={mediaScriptUrl}></script>

        <style>
          /* hide scrollbar (webkit) */
          .media-thumb::-webkit-scrollbar { display: none; }

          /* subtle active state */
          .media-thumb[aria-current="true"] {
            border-color: rgb(24 24 27); /* zinc-900 */
          }

          /* thumbnails bar scrollbar */
          .media-thumb + .media-thumb { }
          .media-thumb { transition: border-color 180ms ease; }
          .media-thumb:focus-visible { outline: 2px solid rgb(24 24 27); outline-offset: 2px; }

          .media-thumb.is-active { border-color: rgb(24 24 27); }
        </style>

        <section class="mt-14 prose prose-zinc max-w-none">
          <Content />
        </section>

      </article>
    </Container>
  </main>
</BaseLayout>